<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>消息</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"/><style>:root{--bg-card:rgba(13, 14, 23, 0.9);--bg-surface:rgba(24, 25, 36, 0.5);--border:rgba(35, 41, 48, 0.8);--text-primary:#f0f6fc;--text-secondary:#8b949e;--accent-gold:#ffa657;--accent-purple:#bc8cff;--accent-blue:#79c0ff;--accent-red:#ff7b72;--user-bubble:#4b4569;--friend-bubble:#21262d;--username-color:#80a5ce;--send-button-gradient:linear-gradient(135deg, #a378e1, #bc8cff, #79c0ff);--red-packet-color:#fa9d3b;--location-color:#4a90e2}body{margin:0;padding:.5em;background:0 0;font-family:'Segoe UI',sans-serif}.message-card{max-width:650px;margin:1em auto;background:var(--bg-card);border-radius:12px;box-shadow:0 2px 12px rgba(91,88,255,.15);border:1px solid var(--border);overflow:hidden;color:var(--text-primary);position:relative;display:flex;flex-direction:column;min-height:300px}.message-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent-gold),var(--accent-purple),var(--accent-blue));opacity:.8;z-index:10}.chat-session{padding:10px 16px;background:var(--bg-surface);border-bottom:1px solid var(--border);text-align:center;flex-shrink:0}.chat-session.group-header{position:relative}.session-title{font-size:.9em;font-weight:600;color:var(--accent-gold);margin:0}.session-members{display:none;padding:8px 16px;background:var(--bg-surface);border-bottom:1px solid var(--border);font-size:.75em;color:var(--text-secondary)}.session-members.visible{display:block}.toggle-members-btn{background:0 0;border:none;color:var(--icon-color);font-size:.825em;cursor:pointer;padding:5px;opacity:.7;transition:opacity .2s;position:absolute;right:10px;top:50%;transform:translateY(-50%)}.toggle-members-btn:hover{opacity:1}.chat-content{padding:12px 16px;max-height:438px;overflow-y:auto;flex-grow:1}.message-wrapper{margin:8px 0;display:flex;transition:margin .3s ease}.private-chat .message-wrapper{margin:16px 0}.message-wrapper.user{justify-content:flex-end}.message-wrapper.friend{justify-content:flex-start}.message-wrapper.center{justify-content:center}.message-bubble-container{max-width:75%;display:flex;flex-direction:column}.message-wrapper.user .message-bubble-container{align-items:flex-end}.message-wrapper.friend .message-bubble-container{align-items:flex-start}.message-username{font-size:.7em;color:var(--username-color);margin-bottom:2px;padding:0 12px}.message-bubble{padding:8px 12px;border-radius:14px;word-break:break-word;font-size:.85em;line-height:1.4;color:var(--text-primary);user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}.message-wrapper.user .message-bubble{background:var(--user-bubble);border-bottom-right-radius:4px}.message-wrapper.friend .message-bubble{background:var(--friend-bubble);border:1px solid var(--border);border-bottom-left-radius:4px}.message-wrapper.friend .red-packet-bubble,.message-wrapper.user .red-packet-bubble{background:url('https://i.postimg.cc/pL8j84yt/QQ20251004-183403.png') no-repeat center center!important;background-size:100% 100%!important}.system-message{text-align:center;margin:12px 0;font-size:.75em;color:var(--text-secondary)}.message-wrapper.system{margin:8px 0;text-align:center;display:block!important;justify-content:unset!important}.message-wrapper.system .system-message{margin:0}.multi-select-mode .message-wrapper.system{padding-left:0!important;text-align:center;display:block!important;position:relative}.multi-select-mode .message-wrapper.system .checkbox-circle{left:50%;top:-15px;transform:translateX(-50%)}.message-extra-info{font-size:.75em;color:var(--text-secondary);padding:4px 12px 0 12px}.image-preview-bubble{cursor:pointer;width:120px;height:120px;overflow:hidden;padding:10px;border-radius:0;display:flex;align-items:center;justify-content:center;text-align:center}.red-packet-bubble{cursor:pointer;padding:0;border-radius:6px;width:184px;height:70px;overflow:visible;position:relative;background:url('https://i.postimg.cc/pL8j84yt/QQ20251004-183403.png') no-repeat center center!important;background-size:100% 100%!important;display:flex;flex-direction:column;justify-content:flex-start;padding-top:13px}.red-packet-bubble .red-packet-text{padding-left:57px;padding-right:9px;padding-top:0;color:#fff;font-size:.85em;display:flex;flex-direction:column;gap:2px;text-align:left;text-shadow:0 1px 2px rgba(0,0,0,.3)}.red-packet-bubble .red-packet-text .amount{font-size:1.2em;font-weight:600}.red-packet-bubble .red-packet-text .memo{font-size:.85em;opacity:.95}.video-bubble{cursor:pointer;padding:50px;border-radius:18px;width:200px;display:flex;align-items:center;gap:10px}.call-waiting-bubble{text-align:center;padding:.5em 1em;border-radius:16px;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;display:flex;align-items:center;justify-content:center;gap:.5em;font-weight:500;font-size:.7em;cursor:default;animation:pulse 2s ease-in-out infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}.call-request-bubble{cursor:pointer;padding:.5em 1em;border-radius:16px;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;display:flex;align-items:center;justify-content:center;gap:.5em;font-weight:500;font-size:.7em;animation:pulse 2s ease-in-out infinite}.call-accepted-bubble{cursor:pointer;padding:.5em 1em;border-radius:16px;background:linear-gradient(135deg,var(--accent-gold,#d4af37) 0,var(--accent-purple,#a855f7) 100%);color:#fff;display:flex;align-items:center;justify-content:center;gap:.5em;font-weight:500;font-size:.8em;animation:glow 2s ease-in-out infinite}.call-rejected-bubble{cursor:default;padding:.5em 1em;border-radius:16px;background:#666;color:#fff;display:flex;align-items:center;justify-content:center;gap:.5em;font-weight:500;font-size:.8em}.call-ended-bubble{cursor:pointer;padding:.5em 1em;border-radius:16px;background:#888;color:#fff;display:flex;align-items:center;justify-content:center;gap:.5em;font-weight:500;font-size:.8em}@keyframes glow{0%,100%{opacity:1;box-shadow:0 0 5px rgba(212,175,55,.4)}50%{opacity:.8;box-shadow:0 0 10px rgba(212,175,55,.7)}}.location-bubble{cursor:pointer;padding:0;border-radius:6px;width:175px;overflow:hidden;background:#fff;display:flex;flex-direction:column}.location-bubble .location-text{padding:7px 13px;background:#fff;color:#333;font-size:1em;font-weight:600;text-align:left;line-height:1.4;min-height:26px;display:flex;align-items:center}.location-bubble .location-map{width:100%;height:70px;background:url('https://i.postimg.cc/7YF3jT68/1.png') no-repeat center center;background-size:cover}.red-packet-bubble.claimed{background:#999;opacity:.7}.sticker-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:.5em;background:0 0;border-radius:0;max-width:120px;max-height:120px}.sticker-image{max-width:120px;max-height:120px;display:block;object-fit:contain;cursor:default;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;pointer-events:auto;-webkit-user-drag:none;-khtml-user-drag:none;-moz-user-drag:none;-o-user-drag:none;will-change:auto;transform:translateZ(0);-webkit-transform:translateZ(0);backface-visibility:hidden;-webkit-backface-visibility:hidden}.video-bubble{background:var(--friend-bubble);border:1px solid var(--border)}.video-icon{color:#2196f3}.bubble-actions{position:absolute;top:-30px;right:0;display:none;background:var(--bg-surface);border:1px solid var(--border);border-radius:6px;padding:2px;box-shadow:0 2px 8px rgba(0,0,0,.2);z-index:50}.bubble-actions.left-side{right:auto;left:0}.bubble-actions.system-center{right:auto;left:50%;transform:translateX(-50%)}.bubble-actions .action-btn{width:22px;height:22px;border:none;background:0 0;margin:0 1px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.7em}.bubble-actions .edit-btn{color:var(--text-secondary)}.bubble-actions .delete-btn{color:var(--text-secondary)}.bubble-actions .quote-btn{color:var(--text-secondary)}.multi-select-mode .message-wrapper{position:relative;padding-left:40px}.multi-select-mode .checkbox-circle{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:20px;height:20px;border:2px solid var(--border);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}.multi-select-mode .checkbox-circle::before{content:'';position:absolute;width:32px;height:32px;left:50%;top:50%;transform:translate(-50%,-50%)}.multi-select-mode .checkbox-circle.selected{background:var(--accent-red);border-color:var(--accent-red);color:#fff}.multi-select-mode .chat-input-area{display:none!important;visibility:hidden;pointer-events:none;height:0;margin:0;padding:0}.multi-select-mode .action-icon-bar{display:none!important;visibility:hidden;pointer-events:none;height:0;margin:0;padding:0}.multi-select-mode .chat-content{padding-bottom:80px}.multiselect-toolbar{position:fixed;bottom:0;left:0;right:0;background:var(--bg-surface);border-top:1px solid var(--border);padding:12px;display:none;z-index:1000}.multiselect-toolbar .toolbar-buttons{display:flex;gap:12px;justify-content:center}.multiselect-toolbar button{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:700}.multiselect-toolbar .delete-btn{background:#e74c3c;color:#fff}.multiselect-toolbar .cancel-btn{background:#666;color:#fff}.multiselect-inline-toolbar{position:absolute;bottom:8px;left:12px;right:12px;background:var(--bg-surface);border:1px solid var(--border);padding:8px;border-radius:8px;display:none;z-index:1200}.multiselect-inline-toolbar .toolbar-buttons{display:flex;gap:10px;justify-content:center}.multiselect-inline-toolbar button{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:.9em}.multiselect-inline-toolbar .delete-btn{background:#e74c3c;color:#fff}.multiselect-inline-toolbar .cancel-btn{background:#666;color:#fff}.chat-content::-webkit-scrollbar{width:6px}.chat-content::-webkit-scrollbar-track{background:var(--bg-card);border-radius:4px}.chat-content::-webkit-scrollbar-thumb{background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));border-radius:4px;transition:background .3s ease}.chat-content::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,var(--accent-red),var(--accent-purple))}.popup-content::-webkit-scrollbar{width:6px}.popup-content::-webkit-scrollbar-track{background:var(--bg-surface);border-radius:3px}.popup-content::-webkit-scrollbar-thumb{background:var(--send-button-gradient);border-radius:3px}.popup-content::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,var(--accent-gold),var(--accent-red))}.sticker-grid::-webkit-scrollbar{width:6px}.sticker-grid::-webkit-scrollbar-track{background:var(--bg-surface);border-radius:3px}.sticker-grid::-webkit-scrollbar-thumb{background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));border-radius:3px}.sticker-grid::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,var(--accent-red),var(--accent-purple))}.sticker-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-height:150px;overflow-y:auto;overflow-x:hidden;padding:8px;box-sizing:border-box;width:100%}@media (min-height:600px){.sticker-grid{max-height:350px}}.sticker-option{width:100%;aspect-ratio:1;cursor:pointer;border-radius:8px;overflow:hidden;transition:transform .2s;position:relative}.sticker-option img{-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;pointer-events:none}@media (max-width:768px){.sticker-grid{grid-template-columns:repeat(3,1fr);gap:10px}}.location-icon{font-size:1.5em;color:var(--location-color)}.card-content{flex-grow:1}.card-title{font-weight:600;font-size:.9em}.card-subtitle{font-size:.75em;opacity:.8;margin-top:4px}.action-icon-bar{display:flex;gap:16px;padding:8px 12px;border-top:1px solid var(--border);background:var(--bg-surface)}.action-icon{color:var(--text-secondary);font-size:1.1em;cursor:pointer;transition:color .2s}.action-icon:hover{color:var(--text-primary)}.action-icon.disabled{color:#555;cursor:not-allowed}.action-icon.active{color:var(--accent-red)}.action-icon[data-action=system].active{color:var(--accent-red)}.chat-input-area{display:flex;align-items:center;padding:8px 12px;border-top:1px solid var(--border);background:var(--bg-surface);flex-shrink:0;width:100%;box-sizing:border-box}.chat-input{border:1px solid var(--border);background:var(--bg-card);color:var(--text-primary);border-radius:6px;padding:6px 10px;font-size:.85em;width:100%;margin-right:8px;outline:0}.send-button{background:var(--send-button-gradient);color:#fff;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-weight:700;font-size:.85em;margin-left:auto;flex-shrink:0}@keyframes button-flash{0%,100%{filter:brightness(1)}50%{filter:brightness(1.5)}}.send-button.sending{animation:button-flash .5s ease-in-out;cursor:wait}.popup-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:100;overflow:auto;box-sizing:border-box;padding:1em;cursor:pointer;opacity:0;transition:opacity .2s ease;pointer-events:none;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}.popup-overlay.show{opacity:1;pointer-events:all}.popup-content{background:var(--bg-surface);padding:1.5em;border-radius:8px;border:1px solid var(--border);max-width:90%;max-height:90%;overflow-y:auto;cursor:default;transform:scale(.9);transition:transform .2s ease}.popup-overlay.show .popup-content{transform:scale(1)}.popup-content.image-popup{border:none;border-radius:0;padding:1em;background:var(--user-bubble);width:240px;height:240px;max-width:240px;max-height:240px;overflow-y:auto;overflow-x:hidden;display:flex;align-items:center;justify-content:center;text-align:center;box-sizing:border-box}.popup-content.image-popup p{margin:auto;word-break:break-word}.popup-content.image-popup img{max-width:100%;max-height:100%;object-fit:contain}.popup-content.image-popup::-webkit-scrollbar{width:6px}.popup-content.image-popup::-webkit-scrollbar-track{background:var(--bg-card);border-radius:3px}.popup-content.image-popup::-webkit-scrollbar-thumb{background:linear-gradient(135deg,var(--accent-purple),var(--accent-blue));border-radius:3px}.popup-content.image-popup::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,var(--accent-red),var(--accent-purple))}.popup-content.red-packet-popup{max-width:280px;width:100%}.popup-content.red-packet-claim-popup{max-width:300px;width:100%;text-align:center}.popup-content.sticker-popup{max-width:360px;width:90%;max-height:250px;box-sizing:border-box;overflow:visible}.popup-content.call-popup{max-width:640px;width:95%;max-height:85vh;padding:1.2em;overflow:visible;display:flex;flex-direction:column}.popup-content.call-popup #call-history-container{padding:.3em;font-size:.95em}.popup-content.call-popup .call-message-item{padding:8px 0!important}.popup-content.call-popup .chat-input{height:42px;padding:8px 12px}.popup-content.call-popup .popup-buttons{margin-top:.3em!important}#call-history-container::-webkit-scrollbar{width:6px}#call-history-container::-webkit-scrollbar-track{background:0 0}#call-history-container::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#667eea 0,#764ba2 100%);border-radius:3px}#call-history-container::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,#764ba2 0,#667eea 100%)}.sticker-suggestions{position:absolute;bottom:60px;left:10px;right:10px;background:var(--bg-surface);border:1px solid var(--border);border-radius:12px;padding:.5em;height:100px;overflow-x:auto;overflow-y:hidden;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;display:none;white-space:nowrap}.sticker-suggestions.show{display:block}.sticker-suggestions::-webkit-scrollbar{height:6px}.sticker-suggestions::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:3px}.sticker-suggestions::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#667eea 0,#764ba2 100%);border-radius:3px}.sticker-suggestions::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,#764ba2 0,#667eea 100%)}.sticker-suggestion-item{cursor:pointer;padding:.3em;border-radius:8px;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;margin-right:.5em;vertical-align:top}.sticker-suggestion-item:hover{background:var(--hover-bg,rgba(255,255,255,.1));transform:scale(1.05)}.sticker-suggestion-item img{width:70px;height:70px;object-fit:cover;border-radius:8px}.popup-input{margin-bottom:1em;width:100%;box-sizing:border-box}.popup-buttons{display:flex;gap:20px;justify-content:center;margin-top:1em;align-items:center}.popup-buttons button{width:100px;flex:none;margin-left:0}.red-packet-open-btn{background:var(--red-packet-color);color:#fff;border:none;border-radius:50%;width:60px;height:60px;cursor:pointer;font-weight:700;font-size:1.2em;margin:15px auto 0;display:flex;align-items:center;justify-content:center}.red-packet-open-btn.claimed,.red-packet-open-btn:disabled{background:#666;cursor:not-allowed}</style><script type="module"></script></head><body><div id="message-container"></div><template id="inline-multiselect-template"><div class="multiselect-inline-toolbar"><div class="toolbar-buttons"><button class="delete-btn" data-role="inline-delete">删除</button> <button class="cancel-btn" data-role="inline-cancel">取消</button></div></div></template><div class="multiselect-toolbar" id="multiselect-toolbar"><div class="toolbar-buttons"><button class="delete-btn" id="multiselect-delete">删除选中</button> <button class="cancel-btn" id="multiselect-cancel">取消</button></div></div><script>!function(){let e="";if(window.__MESSAGE_DATA__)e=window.__MESSAGE_DATA__,e=e.replace(/\{\{USER_PLACEHOLDER\}\}/g,"{{user}}"),console.log("[消息界面] 从全局变量获取数据，长度:",e.length);else{const t=document.getElementById("message-data");t&&(e=t.textContent||t.innerText||"",console.log("[消息界面] 从当前文档获取数据，长度:",e.length))}if((!e||""===e.trim())&&window.parent&&window.parent!==window)try{const t=window.parent.document.getElementById("message-data");t&&(e=t.textContent||t.innerText||"",console.log("[消息界面] 从父文档获取数据，长度:",e.length))}catch(e){console.log("[消息界面] 无法访问父文档（可能是跨域）")}if((!e||""===e.trim())&&window.parent&&window.parent!==window)try{window.parent.__MESSAGE_DATA__&&(e=window.parent.__MESSAGE_DATA__,e=e.replace(/\{\{USER_PLACEHOLDER\}\}/g,"{{user}}"),console.log("[消息界面] 从父窗口全局变量获取数据，长度:",e.length))}catch(e){console.log("[消息界面] 无法访问父窗口全局变量")}e&&""!==e.trim()||(e="$1",console.log("[消息界面] 使用内联数据"));const t=document.getElementById("message-container"),s={};let n=null,o=!1,c=new Set;document.getElementById("multiselect-toolbar");const a={currentPopupType:null,resetOverlayStyle(e){e.style.cssText="",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center"},show(e,t,s=null){t&&(e.querySelector(".popup-content").innerHTML=t),e.style.display="flex",e.offsetHeight,e.classList.add("show"),this.currentPopupType=s},hide(e){const t="sticker"===this.currentPopupType;this.currentPopupType=null,e.classList.remove("show"),setTimeout(()=>{e.style.display="none",t&&requestAnimationFrame(()=>{const t=e.closest(".message-card");if(t){const e=t.querySelector(".chat-content");if(e){e.querySelectorAll(".sticker-image").forEach(e=>{e.offsetHeight});const t=e.scrollTop;e.scrollTop=t+.1,e.scrollTop=t}}})},200)},hideAll(){document.querySelectorAll(".popup-overlay").forEach(e=>{this.hide(e)})}};function i(e,t,s=""){const n=document.querySelector(`.message-card[data-chat-title="${escape(e)}"]`);if(!n)return;const o=n.querySelector(".chat-input");if(!o)return;const c={text:"回复...",media:"请在此输入图片描述...",voice:"请在此输入语音内容...",location:"请在此输入定位描述...",quote:s||"引用消息",system:"请输入系统消息..."};o.placeholder=c[t]||c.text}function l(e){r();const l=e.closest(".message-wrapper");if(!l)return;const d=document.createElement("div");d.className="bubble-actions";const m=l.classList.contains("center");l.classList.contains("system")||e.classList.contains("system-message")||m?(d.classList.add("system-center"),d.innerHTML='\n                <button class="action-btn edit-btn" title="修改"><i class="fa-solid fa-pencil"></i></button>\n                <button class="action-btn delete-btn" title="删除"><i class="fa-solid fa-trash"></i></button>\n            '):(l.classList.contains("friend")&&d.classList.add("left-side"),d.innerHTML='\n                <button class="action-btn quote-btn" title="引用"><i class="fa-solid fa-reply"></i></button>\n                <button class="action-btn edit-btn" title="修改"><i class="fa-solid fa-pencil"></i></button>\n                <button class="action-btn delete-btn" title="删除"><i class="fa-solid fa-trash"></i></button>\n            '),l.style.position="relative",l.appendChild(d),d.style.display="flex",n=d,d.querySelector(".edit-btn").onclick=t=>{t.stopPropagation(),function(e){let t="",s="text";if(e.classList.contains("system-message"))t=e.textContent||e.innerText||"",s="system";else if(e.classList.contains("sticker-image")||"IMG"===e.tagName&&e.classList.contains("sticker-image"))t=e.alt||"",s="sticker",e.dataset.stickerUrl=e.src;else if(e.classList.contains("sticker-placeholder")){const n=e.querySelector('div[style*="font-size: 0.8em"]');t=n?n.textContent.trim():e.textContent.trim(),s="sticker"}else if(e.classList.contains("red-packet-bubble")){const n=e.querySelector(".amount"),o=e.querySelector(".memo");t=`${n?n.textContent.replace("¥","").trim():""}>${o?o.textContent.trim():""}`,s="redenvelope"}else if(e.classList.contains("location-bubble")){const n=e.querySelector(".location-text");t=n?n.textContent.trim():"",s="location"}else if(e.classList.contains("image-preview-bubble")){const n=e.dataset.fullText;t=n?unescape(n):e.textContent||"",s="media"}else if(e.classList.contains("voice-bubble")){const n=e.closest(".message-bubble-container")?.querySelector(".message-extra-info");t=n?n.textContent.replace("转文本: ","").trim():"",s="voice"}else if(e.classList.contains("video-bubble")){const n=e.querySelector(".card-title"),o=e.querySelector(".card-subtitle");t=n?n.textContent.trim():"",o&&"视频通话"===o.textContent?s="videocall":o&&"语音电话"===o.textContent&&(s="voicecall")}else t=e.textContent||e.innerText||"";!function(e,t,s="text"){const n=document.querySelector(".popup-overlay");e.dataset.originalText=t,e.dataset.messageType=s;const o=`\n            <h4 style="text-align: center; font-weight: bold; margin-bottom: 1em;">编辑消息</h4>\n            <textarea class="chat-input popup-input" id="edit-textarea" placeholder="编辑消息内容..." style="height: 80px; resize: vertical;">${t}</textarea>\n            <div class="popup-buttons">\n                <button class="send-button" id="edit-submit">确认</button>\n                <button class="send-button" id="edit-cancel" style="background: #666;">取消</button>\n            </div>`,c=n.querySelector(".popup-content");c.className="popup-content red-packet-popup",a.show(n,o),c.onclick=e=>e.stopPropagation(),c.querySelector("#edit-submit").onclick=async t=>{t.stopPropagation();const s=c.querySelector("#edit-textarea").value.trim();if(s){if(a.hide(n),e.classList.contains("location-bubble")){const t=e.querySelector(".location-text");t&&(t.textContent=s)}else if(e.classList.contains("sticker-placeholder")||e.classList.contains("sticker-image")||"IMG"===e.tagName&&e.classList.contains("sticker-image")){if("IMG"===e.tagName&&e.classList.contains("sticker-image")){const t=e.alt;e.alt=s,t!==s&&(async()=>{const t=await p(s);if(t&&e.parentNode){e.src!==t&&(e.src=t)}})()}else if(e.classList.contains("sticker-placeholder")){const t=e.querySelector('div[style*="font-size: 0.8em"]');t?t.textContent=s:e.textContent=s,e.dataset.stickerDescription=escape(s),(async()=>{const t=await p(s);if(t&&e.parentNode){const n=document.createElement("img");n.className="sticker-image",n.src=t,n.alt=s,n.style.cssText="max-width: 120px; max-height: 120px; display: block; object-fit: contain;",n.onerror=function(){this.outerHTML=`<div class='sticker-placeholder' data-sticker-description="${escape(s)}"><i class='fa-regular fa-face-laugh' style='font-size: 2em; margin: 0.2em;'></i><div style='font-size: 0.8em; color: var(--text-secondary);'>${s}</div></div>`},e.replaceWith(n)}})()}}else if(e.classList.contains("red-packet-bubble")){const t=s.split(">"),n=t[0]||"",o=t[1]||"恭喜发财",c=e.querySelector(".amount"),a=e.querySelector(".memo");c&&(c.textContent=`¥${n}`),a&&(a.textContent=o)}else e.textContent=s;setTimeout(async()=>{try{const t=e.closest(".message-wrapper"),n=t.closest(".chat-content").closest(".message-card"),o=unescape(n.dataset.chatTitle),c=n.dataset.chatType,a=e.dataset.originalText,i=e.dataset.messageType||"text",l=getCurrentMessageId(),r=getChatMessages(l)[0]?.message||"";if(r&&a){const e=function(e,t,s,n,o,c="text"){if(!n||!o)return e;let a,i;if("群聊"===s){if(a=new RegExp(`(<groupmsg\\s+title="${v(t)}"[^>]*>)([\\s\\S]*?)(<\\/groupmsg>)`,"i"),i=e.match(a),i){const[,t,s,l]=i,r=s.split("\n");let d=-1;for(let e=0;e<r.length;e++){const t=r[e].trim();if(t.includes(n)&&t.includes("{{user}} |")){const s=t.match(/\|([^:]+):/);if(!s){d=e;break}if(s[1].trim()===c){d=e;break}}}if(d>=0){let s="text";const n=r[d].match(/\|([^:]+):/);n&&(s=n[1].trim()),r[d]=`{{user}} | ${s}: ${o}`;const c=t+"\n"+r.join("\n")+"\n"+l;return e.replace(a,c)}}}else{const s=[...e.matchAll(/<privatemsg\s+send="([^"]+)"\s+receive="([^"]+)"[^>]*>([\s\S]*?)<\/privatemsg>/g)];for(const l of s){const s=l[1],r=l[2];if(("{{user}}"===r?s:r)===t){if(a=new RegExp(`(<privatemsg\\s+send="${v(s)}"\\s+receive="${v(r)}"[^>]*>)([\\s\\S]*?)(<\\/privatemsg>)`,"i"),i=e.match(a),i){const[,t,s,l]=i,r=s.split("\n");let d=-1;for(let e=0;e<r.length;e++){const t=r[e].trim();if(t.includes(n)&&t.includes("{{user}} |")){const s=t.match(/\|([^:]+):/);if(!s){d=e;break}if(s[1].trim()===c){d=e;break}}}if(d>=0){let s="text";const n=r[d].match(/\|([^:]+):/);n&&(s=n[1].trim()),r[d]=`{{user}} | ${s}: ${o}`;const c=t+"\n"+r.join("\n")+"\n"+l;return e.replace(a,c)}}break}}}return e}(r,o,c,a,s,i);e!==r&&await setChatMessages([{message_id:l,message:e}],{refresh:"none"})}}catch(e){console.error("[修改弹窗] 修改楼层时出错:",e)}},0)}else alert("消息内容不能为空")},c.querySelector("#edit-cancel").onclick=e=>{e.stopPropagation(),a.hide(n)}}(e,t,s)}(e),r()};const g=d.querySelector(".quote-btn");g&&(g.onclick=t=>{t.stopPropagation(),function(e){const t=e.closest(".message-wrapper"),n=t.closest(".chat-content"),o=n.dataset.title,c=e.textContent||e.innerText||"",a=t.querySelector(".message-username"),l=a?a.textContent:"用户",r=n.parentElement.querySelector(".chat-input-area").querySelector(".chat-input");if(r){s[o]="quote",r.dataset.quotedText=c,r.dataset.quotedSender=l;i(o,"quote",`引用：${c.substring(0,15)}${c.length>15?"...":""}`);const e=n.closest(".message-card");e.querySelectorAll(".action-icon.mode-toggle-icon").forEach(e=>{e.classList.remove("active")});const t=e.querySelector('.action-icon[data-action="q"]');t&&t.classList.add("active"),r.focus()}}(e),r()}),d.querySelector(".delete-btn").onclick=s=>{s.stopPropagation();!function(e){o=!0,c.clear(),t.classList.add("multi-select-mode");const s=(e||t.querySelector(".message-wrapper"))?.closest(".message-card");if(s){if(!s.querySelector(".multiselect-inline-toolbar")){const e=document.getElementById("inline-multiselect-template");if(e&&e.content){const t=e.content.firstElementChild.cloneNode(!0);s.style.position="relative",s.appendChild(t)}}const e=s.querySelector(".multiselect-inline-toolbar");e&&(e.style.display="block")}if(t.querySelectorAll(".message-wrapper").forEach((e,t)=>{if(!e.querySelector(".checkbox-circle")){const t=document.createElement("div");t.className="checkbox-circle",t.innerHTML='<i class="fa-solid fa-check" style="display: none;"></i>',e.appendChild(t)}}),e){const t=e.querySelector(".checkbox-circle");t&&u(e,t)}}(e.closest(".message-wrapper")),r()}}function r(){n&&(n.remove(),n=null)}function d(){o=!1,c.clear(),t.classList.remove("multi-select-mode"),t.querySelectorAll(".multiselect-inline-toolbar").forEach(e=>{e.style.display="none",e.remove()}),t.querySelectorAll(".checkbox-circle").forEach(e=>{e.remove()})}function u(e,t){const s=function(e){const t=e.closest(".chat-content"),s=t.dataset.title,n=Array.from(t.querySelectorAll(".message-wrapper")).indexOf(e);return`${s}-${n}`}(e);c.has(s)?(c.delete(s),t.classList.remove("selected"),t.querySelector("i").style.display="none"):(c.add(s),t.classList.add("selected"),t.querySelector("i").style.display="block"),document.getElementById("multiselect-delete").disabled=0===c.size}function m(e,t,s="text"){const n=document.querySelector(`.chat-content[data-title="${e}"]`);if(!n)return;if("system"===s){const e=document.createElement("div");return e.className="message-wrapper system",e.innerHTML=`<div class="system-message">${t}</div>`,n.appendChild(e),void(n.scrollTop=n.scrollHeight)}const o=document.createElement("div");o.className="message-wrapper user";const c=n.classList.contains("private-chat")?"":'<div class="message-username">{{user}}</div>';let a="",i="";switch(s){case"quote":{const e=t.split(">"),s=(e[0]||"").trim();a=`<div class="message-bubble">${(e[1]||"").trim()}</div>`,i=`<div class="message-extra-info">${s.includes(":")?s.split(":").slice(1).join(":").trim():s}</div>`;break}case"voice":a=`<div class="message-bubble voice-bubble"><i class="fa-solid fa-waveform"></i> ${Math.max(1,Math.round(t.length/4))}s</div>`,i=`<div class="message-extra-info">转文本: ${t}</div>`;break;case"media":if(t.includes("<img>")&&t.includes("</img>")){const e=t.match(/<img>(.*?)<\/img>/);if(e){const s=e[1];a=`<div class="message-bubble image-preview-bubble" style="background-image: url('${s}'); background-size: cover; background-position: center;" data-full-text="${escape(t)}" onclick="showImagePreview('${s}', '图片')"></div>`}else{const e=t.length>30?t.substring(0,30)+"...":t;a=`<div class="message-bubble image-preview-bubble" data-full-text="${escape(t)}">${e}</div>`}}else{const e=t.length>30?t.substring(0,30)+"...":t;a=`<div class="message-bubble image-preview-bubble" data-full-text="${escape(t)}">${e}</div>`}break;case"location":a=`<div class="message-bubble location-bubble"><div class="location-text">${t}</div><div class="location-map"></div></div>`;break;case"videocall":case"voicecall":break;case"sticker":a=`<div class="sticker-placeholder" data-sticker-description="${escape(t)}"><i class="fa-regular fa-face-laugh" style="font-size: 2em; margin: 0.2em;"></i><div style="font-size: 0.8em; color: var(--text-secondary);">${t}</div></div>`,(async()=>{try{const e=await p(t);if(e){n.querySelectorAll(`.sticker-placeholder[data-sticker-description="${escape(t)}"]`).forEach(s=>{const n=document.createElement("img");n.className="sticker-image",n.src=e,n.alt=t,n.style.cssText="max-width: 120px; max-height: 120px; display: block; object-fit: contain;",n.onerror=function(){this.outerHTML=`<div class='sticker-placeholder'><i class='fa-regular fa-face-laugh' style='font-size: 2em; margin: 0.2em;'></i><div style='font-size: 0.8em; color: var(--text-secondary);'>${t}</div></div>`},s.replaceWith(n)})}}catch(e){console.error("[表情包加载] 加载表情包时出错:",e)}})();break;default:a=`<div class="message-bubble">${t}</div>`}o.innerHTML=`<div class="message-bubble-container">${c}${a}${i}</div>`,n.appendChild(o),n.scrollTop=n.scrollHeight}async function p(e){try{console.log("[表情包] 开始查找表情包:",e);const t=getWorldbookNames();console.log("[表情包] 所有世界书:",t);const s=t.filter(e=>{const t=e.toLowerCase();return t.includes("sticker")||t.includes("表情包")||t.includes("emoji")});console.log("[表情包] 筛选出的表情包世界书:",s);const n=s.length>0?s:t;console.log("[表情包] 将要搜索的世界书:",n);for(const t of n)try{const s=await getWorldbook(t);if(!s||!Array.isArray(s)){console.log(`[表情包] 世界书 "${t}" 没有条目`);continue}console.log(`[表情包] 世界书 "${t}" 有 ${s.length} 个条目`);for(const t of s){const s=(t.content||"").split("\n").filter(e=>e.trim());for(const t of s){const s=t.indexOf(":");if(s>0){const n=t.substring(0,s).trim();let o=t.substring(s+1).trim();if(n===e&&o){console.log("[表情包] 找到匹配的描述，原始code:",o),o=o.replace(/\s+/g,"").replace(/['"]/g,""),console.log("[表情包] 清理后的code:",o);const e=o.includes("/")?`https://i.postimg.cc/${o}`:`https://files.catbox.moe/${o}`;return console.log("[表情包] 生成的图片URL:",e),e}}}}}catch(e){console.error(`[表情包] 获取世界书 "${t}" 失败:`,e)}console.log("[表情包] 未找到匹配的表情包")}catch(e){console.error("[表情包] 查找错误:",e)}return null}function g(e){const t=[],s=/<privatemsg\s+send="([^"]+)"\s+receive="([^"]+)">([\s\S]*?)<\/privatemsg>/g,n=/<groupmsg\s+title="([^"]+)"\s+send="([^"]+)"\s+receive="([^"]+)">([\s\S]*?)<\/groupmsg>/g;let o;for(;null!==(o=s.exec(e));){const e=o[1],s=o[2],n=o[3].trim().split("\n").filter(e=>""!==e.trim()),c={type:"私聊",title:"{{user}}"===s?e:s,send:e,receive:s,members:[],log:[]};for(const t of n){if(t.trim().startsWith("system")){const e=t.match(/system[：:]\s*(.+)/);e&&c.log.push({senderType:"s",content:e[1].trim()});continue}const s=t.split("|").map(e=>e.trim());if(s.length<2)continue;const n=s[0],o=s[1].match(/^([^:]+):(.*)$/);if(!o)continue;const a=o[1].trim(),i=o[2].trim(),l=n===e?"send":"receive";c.log.push({senderType:l,senderName:n,contentType:a,content:i})}t.push(c)}for(;null!==(o=n.exec(e));){const e=o[1],s=o[2],n=o[3],c=o[4].trim().split("\n").filter(e=>""!==e.trim()),a=[s];n&&a.push(...n.split(",").map(e=>e.trim()));const i={type:"群聊",title:e,send:s,receive:n,members:a,log:[]};for(const e of c){if(e.trim().startsWith("system")){const t=e.match(/system[：:]\s*(.+)/);t&&i.log.push({senderType:"s",content:t[1].trim()});continue}const t=e.split("|").map(e=>e.trim());if(t.length<2)continue;const s=t[0],n=t[1].match(/^([^:]+):(.*)$/);if(!n)continue;const o=n[1].trim(),c=n[2].trim();i.log.push({senderType:"send",senderName:s,contentType:o,content:c})}t.push(i)}return t}function f(e,t){let s=e;for(const e of t){let t,n="";if(e.send&&e.receive){n=`<privatemsg send="${e.send}" receive="${e.receive}">\n`;for(const t of e.log)if("s"===t.senderType)n+=`system: ${t.content}\n`;else{n+=`${t.senderName||"未知"} | ${t.contentType}: ${t.content}\n`}n+="</privatemsg>",t=new RegExp(`<privatemsg\\s+send="${v(e.send)}"\\s+receive="${v(e.receive)}"[^>]*>[\\s\\S]*?<\\/privatemsg>`,"g")}else{const s=e.title;n=`<groupmsg title="${s}" send="${e.send||""}" receive="${e.receive||""}">\n`;for(const t of e.log)if("s"===t.senderType)n+=`system: ${t.content}\n`;else{n+=`${t.senderName||"未知"} | ${t.contentType}: ${t.content}\n`}n+="</groupmsg>",t=new RegExp(`<groupmsg\\s+title="${v(s)}"[^>]*>[\\s\\S]*?<\\/groupmsg>`,"g")}s=s.replace(t,n)}return s}function v(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function y(e,t,s){try{const n=g(s).find(t=>t.title===e);if(!n)return"{{user}}";if("私聊"===t)return"{{user}}"===n.receive?n.send:n.receive;{const e=[n.send];n.receive&&e.push(...n.receive.split(",").map(e=>e.trim()));return e.some(e=>"{{user}}"===e||e.includes("{{user}}"))?"{{user}}":n.send}}catch(e){return console.error("[获取用户名] 出错:",e),"{{user}}"}}function b(e,t,s,n){if(!n||!n.trim())return e;const o=n.trim();if("群聊"===s){const s=new RegExp(`(<groupmsg\\s+title="${v(t)}"[^>]*>)([\\s\\S]*?)(<\\/groupmsg>)`,"i"),n=e.match(s);if(n){const[,t,c,a]=n,i=t+"\n"+(c.trim()+"\n"+o)+"\n"+a;return e.replace(s,i)}}else{const s=[...e.matchAll(/<privatemsg\s+send="([^"]+)"\s+receive="([^"]+)"[^>]*>([\s\S]*?)<\/privatemsg>/g)];for(const n of s){const s=n[1],c=n[2];if(("{{user}}"===c?s:c)===t){const t=new RegExp(`(<privatemsg\\s+send="${v(s)}"\\s+receive="${v(c)}"[^>]*>)([\\s\\S]*?)(<\\/privatemsg>)`,"i"),n=e.match(t);if(n){const[,s,c,a]=n,i=s+"\n"+(c.trim()+"\n"+o)+"\n"+a;return e.replace(t,i)}}}}return e}function h(e,t,s,n){if(!n)return e;let o,c;const a=["text:","media:","voice:","redenvelope:","location:","videocall:","voicecall:","sticker:","quote:"];if("群聊"===s){if(o=new RegExp(`(<groupmsg\\s+title="${v(t)}"[^>]*>)([\\s\\S]*?)(<\\/groupmsg>)`,"i"),c=e.match(o),c){const[,t,s,i]=c,l=s.split("\n");let r=-1;for(let e=0;e<l.length;e++){const t=l[e].trim();if(t.includes(n)&&(t.includes("|")&&a.some(e=>t.includes(e)))){if(a.flatMap(e=>[`${e} ${n}`,`${e}${n}`]).some(e=>t.includes(e))){r=e;break}r<0&&(r=e)}}if(r>=0){l.splice(r,1);const s=t+"\n"+l.join("\n")+"\n"+i;return e.replace(o,s)}}}else{const s=[...e.matchAll(/<privatemsg\s+send="([^"]+)"\s+receive="([^"]+)"[^>]*>([\s\S]*?)<\/privatemsg>/g)];for(const i of s){const s=i[1],l=i[2];if(("{{user}}"===l?s:l)===t){if(o=new RegExp(`(<privatemsg\\s+send="${v(s)}"\\s+receive="${v(l)}"[^>]*>)([\\s\\S]*?)(<\\/privatemsg>)`,"i"),c=e.match(o),c){const[,t,s,i]=c,l=s.split("\n");let r=-1;for(let e=0;e<l.length;e++){const t=l[e].trim();if(t.includes(n)&&(t.includes("|")&&a.some(e=>t.includes(e)))){if(a.flatMap(e=>[`${e} ${n}`,`${e}${n}`]).some(e=>t.includes(e))){r=e;break}r<0&&(r=e)}}if(r>=0){l.splice(r,1);const s=t+"\n"+l.join("\n")+"\n"+i;return e.replace(o,s)}}break}}}return e}async function x(e,t){const s=e.dataset.chatType,n=unescape(e.dataset.chatTitle),o=document.querySelector(`.chat-content[data-title="${n}"]`);if(!o)return;const c=w.getIcon(t),a=`${w.getText(t)}电话`,i=T("call-waiting-bubble",`<i class="fa-solid ${c}"></i><span>等待接通中……</span>`,{callType:t}),l=document.createDocumentFragment();l.appendChild(i),o.appendChild(l),o.scrollTop=o.scrollHeight,setTimeout(async()=>{try{const e=getCurrentMessageId(),t=getChatMessages(e)[0]?.message||"";if(t){const o=b(t,n,s,`system: {{user}}申请接通${n}的${a}`);o!==t&&await setChatMessages([{message_id:e,message:o}],{refresh:"none"})}}catch(e){console.error(`[${a}] 写入楼层时出错:`,e)}},0)}function $(e,t){const s=e.querySelector(".popup-overlay"),n=(e.dataset.chatType,unescape(e.dataset.chatTitle)),o=[];try{const e=getCurrentMessageId(),s=getChatMessages(e)[0]?.message||"";if(s){const e=g(s).find(e=>e.title===n);if(e){const s="video"===t?"videocall":"voicecall";e.log.forEach(e=>{if(e.contentType===s){const t=`${e.senderName||"未知"}：${e.content}`;o.push(t)}})}}}catch(e){console.error("[通话历史] 获取历史记录失败:",e)}const c=`\n              <div style="display: flex; flex-direction: column; height: 100%; max-height: calc(80vh - 2em);">\n                <h4 style="flex-shrink: 0; text-align: center; font-weight: bold; margin: 0 0 1em 0; padding-bottom: 0.5em; border-bottom: 1px solid var(--border);">${"video"===t?"视频通话记录":"语音通话记录"}</h4>\n                <div id="call-history-container" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 0.3em; background: var(--bg-surface); border-radius: 8px; min-height: 200px; max-height: calc(80vh - 8em); font-size: 0.95em;">\n                  ${o.length>0?o.map((e,t)=>`<div style="padding: 8px 0; word-wrap: break-word; ${t>0?"border-top: 1px solid var(--border);":""}">${e}</div>`).join(""):'<div style="color: var(--text-secondary); text-align: center;">暂无通话记录</div>'}\n                </div>\n              </div>`,i=s.querySelector(".popup-content");i.className="popup-content call-popup",a.resetOverlayStyle(s),a.show(s,c),s.onclick=()=>{a.hide(s)},i.onclick=e=>e.stopPropagation()}function k(t,s){const n=t.querySelector(".popup-overlay"),o=t.dataset.chatType,c=unescape(t.dataset.chatTitle),i=[];try{const e=getCurrentMessageId(),t=getChatMessages(e)[0]?.message||"";if(t){const e=g(t).find(e=>e.title===c);if(e){const t="video"===s?"videocall":"voicecall";e.log.forEach(e=>{if(e.contentType===t){const t=`${e.senderName||"未知"}：${e.content}`;i.push(t)}})}}}catch(e){console.error("[通话] 获取历史记录失败:",e)}const l=`\n            <div style="display: flex; flex-direction: column; height: 100%; max-height: calc(80vh - 2em);">\n              <div id="call-history-container" style="flex: 1; overflow-y: auto; overflow-x: hidden; margin-bottom: 1em; padding: 0.3em; background: var(--bg-surface); border-radius: 8px; min-height: 150px; max-height: calc(80vh - 12em); font-size: 0.95em;">\n                ${i.length>0?i.map((e,t)=>`<div class="call-message-item" data-message-index="${t}" style="padding: 8px 0; word-wrap: break-word; cursor: pointer; position: relative; ${t>0?"border-top: 1px solid var(--border);":""}">${e}</div>`).join(""):'<div style="color: var(--text-secondary); text-align: center;">暂无通话记录</div>'}\n              </div>\n              <div style="flex-shrink: 0;">\n                <input type="text" class="chat-input popup-input" id="call-content-input" placeholder="描述通话内容..." autocomplete="off" spellcheck="false">\n                <div class="popup-buttons" style="margin-top: 0.5em;">\n                  <button class="send-button" id="call-submit">发送</button>\n                  <button class="send-button" id="call-hangup" style="background: #f44336;">挂断</button>\n                </div>\n              </div>\n            </div>`,r=n.querySelector(".popup-content");r.className="popup-content call-popup",a.resetOverlayStyle(n),a.show(n,l),r.onclick=e=>e.stopPropagation(),setTimeout(()=>{const e=r.querySelector("#call-history-container");e&&(e.scrollTop=e.scrollHeight);const t=r.querySelector("#call-content-input");t&&(t.focus(),t.addEventListener("keypress",e=>{if("Enter"===e.key){e.stopPropagation(),e.preventDefault();const t=r.querySelector("#call-submit");t&&t.click()}}))},250),r.querySelector("#call-submit").onclick=async t=>{t.stopPropagation();const n=r.querySelector("#call-content-input"),a=n.value.trim();if(!a)return;n.value="",n.focus();const i=r.querySelector("#call-history-container");if(i){i.querySelector('[style*="text-align: center"]')&&(i.innerHTML="");const e=document.createElement("div");e.className="call-message-item",e.dataset.messageIndex=i.querySelectorAll(".call-message-item").length,e.style.cssText="padding: 8px 0; word-wrap: break-word; cursor: pointer; position: relative;",i.children.length>0&&(e.style.borderTop="1px solid var(--border)"),e.textContent=`{{user}}：${a}`,i.appendChild(e),i.scrollTop=i.scrollHeight}setTimeout(async()=>{try{const t=getCurrentMessageId(),n=getChatMessages(t)[0]?.message||"";if(n){const i="video"===s?"videocall":"voicecall",l=y(c,o,n),r=b(n,c,o,`${l} | ${i}: ${a}`);r!==n&&(await setChatMessages([{message_id:t,message:r}],{refresh:"none"}),console.log("[通话] 通话内容已写入楼层"),e=r)}}catch(e){console.error("[通话] 写入楼层时出错:",e)}},0)},r.querySelector("#call-hangup").onclick=async t=>{t.stopPropagation();try{const t=getCurrentMessageId(),n=getChatMessages(t)[0]?.message||"";if(n){const a=b(n,c,o,`system: {{user}}挂断了${"video"===s?"视频":"语音"}电话`);if(a!==n){await setChatMessages([{message_id:t,message:a}],{refresh:"none"}),console.log("[通话-挂断] 挂断消息已写入楼层"),e=a;const n=document.querySelector(`.chat-content[data-title="${c}"]`);if(n){const e=n.querySelectorAll(".call-accepted-bubble"),t=w.getIcon(s),o=w.getText(s);for(const c of e)c.dataset.callType===s&&(c.className="message-bubble call-ended-bubble",c.dataset.callType=s,c.innerHTML=`<i class="fa-solid ${t}"></i><span>${o}通话已结束</span>`,c.onclick=()=>{$(n.closest(".message-card"),s)})}}}}catch(e){console.error("[通话-挂断] 写入楼层时出错:",e)}a.hide(n)},setTimeout(()=>{const t=r.querySelector("#call-history-container");t&&function(t,s,n,o){function c(n){const c=t.querySelector(".call-message-actions");c&&c.remove();const a=document.createElement("div");a.className="call-message-actions",a.style.cssText="\n              position: absolute;\n              top: 50%;\n              left: 50%;\n              transform: translate(-50%, -120%);\n              display: flex;\n              background: var(--bg-surface);\n              border: 1px solid var(--border);\n              border-radius: 6px;\n              padding: 2px;\n              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n              z-index: 10000;\n            ",a.innerHTML='\n              <button class="action-btn edit-btn" title="修改" style="width: 22px; height: 22px; border: none; background: none; margin: 0 1px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7em; color: var(--text-secondary);"><i class="fa-solid fa-pencil"></i></button>\n              <button class="action-btn delete-btn" title="删除" style="width: 22px; height: 22px; border: none; background: none; margin: 0 1px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7em; color: var(--text-secondary);"><i class="fa-solid fa-trash"></i></button>\n            ',n.appendChild(a),a.querySelector(".edit-btn").onclick=async t=>{t.stopPropagation();const c=parseInt(n.dataset.messageIndex),i=n.textContent,l=i.indexOf("："),r=l>0?i.substring(l+1).trim():i,d=document.createElement("div");d.style.cssText="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--bg-surface);\n                border: 1px solid var(--border);\n                border-radius: 12px;\n                padding: 1.5em;\n                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n                z-index: 100000;\n                min-width: 300px;\n                max-width: 90vw;\n              ",d.innerHTML=`\n                <h4 style="margin: 0 0 1em 0; text-align: center;">修改通话内容</h4>\n                <textarea id="edit-call-content" style="width: 100%; min-height: 80px; padding: 0.5em; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); resize: vertical; font-family: inherit;">${r}</textarea>\n                <div style="display: flex; gap: 0.5em; margin-top: 1em;">\n                  <button class="send-button" id="confirm-edit" style="flex: 1;">确认</button>\n                  <button class="send-button" id="cancel-edit" style="flex: 1; background: #666;">取消</button>\n                </div>\n              `,document.body.appendChild(d);const u=d.querySelector("#edit-call-content");u.focus(),u.setSelectionRange(u.value.length,u.value.length),d.querySelector("#confirm-edit").onclick=async()=>{const t=u.value.trim();if(t&&t!==r)try{const a=getCurrentMessageId(),r=getChatMessages(a)[0]?.message||"";if(r){const d=g(r),u=d.find(e=>e.title===s);if(u){const s="video"===o?"videocall":"voicecall";let m=0;for(let e=0;e<u.log.length;e++)if(u.log[e].contentType===s){if(m===c){u.log[e].content=t;break}m++}const p=f(r,d);await setChatMessages([{message_id:a,message:p}],{refresh:"none"}),e=p;const g=l>0?i.substring(0,l):"未知";n.textContent=`${g}：${t}`,console.log("[通话-编辑] 消息已更新")}}}catch(e){console.error("[通话-编辑] 编辑消息时出错:",e)}d.remove(),a.remove()},d.querySelector("#cancel-edit").onclick=()=>{d.remove(),a.remove()}},a.querySelector(".delete-btn").onclick=async c=>{c.stopPropagation();const i=parseInt(n.dataset.messageIndex),l=document.createElement("div");l.style.cssText="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: var(--bg-surface);\n                border: 1px solid var(--border);\n                border-radius: 12px;\n                padding: 1.5em;\n                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n                z-index: 100000;\n                min-width: 300px;\n                max-width: 90vw;\n              ",l.innerHTML='\n                <h4 style="margin: 0 0 1em 0; text-align: center;">确认删除</h4>\n                <p style="margin: 0 0 1.5em 0; text-align: center; color: var(--text-secondary);">确定要删除这条通话记录吗？</p>\n                <div style="display: flex; gap: 0.5em;">\n                  <button class="send-button" id="confirm-delete" style="flex: 1; background: #f44336;">删除</button>\n                  <button class="send-button" id="cancel-delete" style="flex: 1; background: #666;">取消</button>\n                </div>\n              ',document.body.appendChild(l),l.querySelector("#confirm-delete").onclick=async()=>{try{const c=getCurrentMessageId(),a=getChatMessages(c)[0]?.message||"";if(a){const l=g(a),r=l.find(e=>e.title===s);if(r){const s="video"===o?"videocall":"voicecall";let d=0,u=-1;for(let e=0;e<r.log.length;e++)if(r.log[e].contentType===s){if(d===i){u=e;break}d++}if(u>=0){r.log.splice(u,1);const s=f(a,l);await setChatMessages([{message_id:c,message:s}],{refresh:"none"}),e=s,n.remove(),t.querySelectorAll(".call-message-item").forEach((e,t)=>{e.dataset.messageIndex=t}),console.log("[通话-删除] 消息已删除")}}}}catch(e){console.error("[通话-删除] 删除消息时出错:",e)}l.remove(),a.remove()},l.querySelector("#cancel-delete").onclick=()=>{l.remove(),a.remove()}},setTimeout(()=>{const e=t=>{a.contains(t.target)||(a.remove(),document.removeEventListener("click",e),document.removeEventListener("touchstart",e))};document.addEventListener("click",e),document.addEventListener("touchstart",e)},100)}q(t,".call-message-item",c)}(t,c,0,s)},100)}const w={getIcon:e=>"video"===e?"fa-video":"fa-phone",getText:e=>"video"===e?"视频":"语音",isVideo:e=>"video"===e};function S(e,t,s){const n=document.querySelector(`.chat-content[data-title="${e}"]`);if(!n)return;const o=n.querySelectorAll(".call-waiting-bubble, .call-request-bubble");let c=null;for(let e=o.length-1;e>=0;e--)if(o[e].dataset.callType===t){c=o[e];break}if(!c)return;const a=w.getIcon(t),i=w.getText(t),l={accepted:{className:"call-accepted-bubble",text:`${i}通话中`,clickable:!0},rejected:{className:"call-rejected-bubble",text:`${i}通话已拒绝`,clickable:!1}}[s];l&&(c.className=`message-bubble ${l.className}`,c.innerHTML=`<i class="fa-solid ${a}"></i><span>${l.text}</span>`,l.clickable&&(c.onclick=()=>{k(n.closest(".message-card"),t)}),n.scrollTop=n.scrollHeight)}function T(e,t,s={}){const n=document.createElement("div");n.className="message-wrapper center";const o=document.createElement("div");return o.className=`message-bubble ${e}`,Object.entries(s).forEach(([e,t])=>{o.dataset[e]=t}),o.innerHTML=t,n.appendChild(o),n}function q(e,t,s,n=500){let o=null;const c=(e,c,a)=>{const i=e.target.closest(t);if(!i)return;const l=c,r=a;o=setTimeout(()=>s(i),n);const d=e=>{const t=e.clientX||e.touches?.[0]?.clientX,s=e.clientY||e.touches?.[0]?.clientY;(Math.abs(t-l)>10||Math.abs(s-r)>10)&&(clearTimeout(o),document.removeEventListener("mousemove",d),document.removeEventListener("touchmove",d))},u=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("touchmove",d),document.removeEventListener("mouseup",u),document.removeEventListener("touchend",u),document.removeEventListener("touchcancel",u)};document.addEventListener("mousemove",d),document.addEventListener("touchmove",d,{passive:!0}),document.addEventListener("mouseup",u),document.addEventListener("touchend",u),document.addEventListener("touchcancel",u)};return e.addEventListener("mousedown",e=>c(e,e.clientX,e.clientY)),e.addEventListener("touchstart",e=>{const t=e.touches[0];c(e,t.clientX,t.clientY)}),e.addEventListener("mouseup",()=>clearTimeout(o)),e.addEventListener("touchend",()=>clearTimeout(o)),()=>{clearTimeout(o)}}async function L(e){const t=e.querySelector(".popup-overlay"),s=e.dataset.chatType,n=unescape(e.dataset.chatTitle);try{let o=[];try{const e=getGlobalWorldbookNames();console.log("[表情包] 全局世界书列表:",e);for(const t of e)try{const e=await getWorldbook(t);console.log(`[表情包] 获取到世界书 "${t}" 的条目:`,e.length),e&&Array.isArray(e)&&(o=o.concat(e))}catch(e){console.log(`[表情包] 获取世界书 "${t}" 失败:`,e)}}catch(e){console.log("[表情包] 获取全局世界书列表失败:",e)}try{const e=getCharWorldbookNames("current");if(console.log("[表情包] 角色卡世界书:",e),e.primary)try{const t=await getWorldbook(e.primary);console.log(`[表情包] 获取到主要世界书 "${e.primary}" 的条目:`,t.length),t&&Array.isArray(t)&&(o=o.concat(t))}catch(t){console.log(`[表情包] 获取主要世界书 "${e.primary}" 失败:`,t)}if(e.additional&&Array.isArray(e.additional))for(const t of e.additional)try{const e=await getWorldbook(t);console.log(`[表情包] 获取到附加世界书 "${t}" 的条目:`,e.length),e&&Array.isArray(e)&&(o=o.concat(e))}catch(e){console.log(`[表情包] 获取附加世界书 "${t}" 失败:`,e)}}catch(e){console.log("[表情包] 获取角色卡世界书失败:",e)}console.log("[表情包] 合并后的所有条目数量:",o.length);const c=o.filter(e=>{const t=(e.name||"").toLowerCase(),s=e.strategy?.keys?e.strategy.keys.map(e=>String(e)).join(",").toLowerCase():"",n=e.strategy?.keys_secondary?.keys?e.strategy.keys_secondary.keys.map(e=>String(e)).join(",").toLowerCase():"";return t.includes("sticker")||t.includes("表情包")||s.includes("sticker")||s.includes("表情包")||n.includes("sticker")||n.includes("表情包")});console.log("[表情包] 筛选出的表情包条目:",c);const i=[];c.forEach(e=>{(e.content||"").split("\n").filter(e=>e.trim()).forEach(t=>{const s=t.indexOf(":");if(s>0){const n=t.substring(0,s).trim();let o=t.substring(s+1).trim();if(n&&o){o=o.replace(/\s+/g,"").replace(/['"]/g,"");const t=o.includes("/"),s=t?"postimg":"catbox",c=t?`https://i.postimg.cc/${o}`:`https://files.catbox.moe/${o}`,a=e.strategy?.keys?e.strategy.keys.map(e=>String(e)).join(", "):e.name;i.push({description:n,imageUrl:c,imageHost:s,code:o,originalKey:a||"未命名"})}}})}),console.log("[表情包] 解析后的表情包:",i);let l="";l=i.length>0?`\n                 <div class="sticker-grid">\n                   ${i.map((e,t)=>`\n                      <div class="sticker-option" data-sticker-index="${t}" title="${e.description}">\n                        <img src="${e.imageUrl}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />\n                        <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; background: var(--bg-surface); color: var(--text-secondary);">\n                          <i class="fa-regular fa-image" style="font-size: 2em;"></i>\n                        </div>\n                      </div>\n                    `).join("")}\n                 </div>\n               `:'\n                <div style="text-align: center; padding: 2em;">\n                  <p style="color: var(--text-secondary); margin-bottom: 1em;">世界书中没有找到表情包</p>\n                  <p style="color: var(--text-secondary); font-size: 0.85em;">请在世界书中添加表情包条目<br/>格式：描述: 图床代码</p>\n                </div>\n              ';const r=`${l}`,d=t.querySelector(".popup-content");d.className="popup-content sticker-popup",d.style.padding="0.8em",d.style.maxHeight="300px",t.style.alignItems="flex-end",t.style.paddingBottom="70px",a.show(t,r,"sticker"),d.onclick=e=>e.stopPropagation(),d.querySelectorAll(".sticker-option").forEach(e=>{e.onmouseenter=()=>{e.style.transform="scale(1.1)",e.style.zIndex="10"},e.onmouseleave=()=>{e.style.transform="scale(1)",e.style.zIndex="1"},e.onclick=()=>{const o=parseInt(e.dataset.stickerIndex),c=i[o];a.hide(t),async function(e,t,s,n){const o=document.querySelector(`.chat-content[data-title="${s}"]`);if(o){const c=document.createDocumentFragment(),a=document.createElement("div");a.className="message-wrapper user";const i=o.classList.contains("private-chat")?"":'<div class="message-username">{{user}}</div>';let l="";l=t.startsWith("http://")||t.startsWith("https://")?`<img class="sticker-image" src="${t}" alt="${e}" style="max-width: 150px; max-height: 150px; display: block;" onerror="this.outerHTML='<div class=\\'sticker-placeholder\\'><i class=\\'fa-regular fa-face-laugh\\' style=\\'font-size: 2em; margin: 0.2em;\\'></i><div style=\\'font-size: 0.8em; color: var(--text-secondary);\\'>${e}</div></div>';" />`:`<div class="sticker-placeholder"><i class="fa-regular fa-face-laugh" style="font-size: 2em; margin: 0.2em;"></i><div style="font-size: 0.8em; color: var(--text-secondary);">${t}</div></div>`,a.innerHTML=`<div class="message-bubble-container">${i}${l}</div>`,c.appendChild(a),o.appendChild(c),o.scrollTop=o.scrollHeight,setTimeout(async()=>{try{console.log("[表情包] 开始写入表情包消息到楼层"),console.log("[表情包] 发送给AI的文字:",e),console.log("[表情包] 界面显示内容:",t);const o=getCurrentMessageId(),c=getChatMessages(o)[0]?.message||"";if(c){const t=`${y(s,n,c)} | sticker: ${e}`;console.log("[表情包] 准备写入的消息:",t);const a=b(c,s,n,t);a!==c&&(await setChatMessages([{message_id:o,message:a}],{refresh:"none"}),console.log("[表情包] 表情包消息已写入楼层"))}}catch(e){console.error("[表情包] 写入楼层时出错:",e)}},0)}}(c.description,c.imageUrl,n,s)}});const u=e.querySelector(".chat-input");if(u){const e=()=>{t.classList.contains("show")&&a.hide(t)};u.addEventListener("focus",e),t.addEventListener("transitionend",function s(){t.classList.contains("show")||(u.removeEventListener("focus",e),t.removeEventListener("transitionend",s))})}}catch(e){console.error("[表情包] 获取世界书失败:",e);const s=`\n               <div style="text-align: center; padding: 2em;">\n                 <p style="color: var(--accent-red); margin-bottom: 1em;">⚠️ 无法加载世界书</p>\n                 <p style="color: var(--text-secondary); margin-bottom: 1.5em; font-size: 0.9em;">错误：${e.message}</p>\n                 <button class="send-button" id="error-close" style="background: #666;">关闭</button>\n               </div>\n             `,n=t.querySelector(".popup-content");n.className="popup-content sticker-popup",n.style.maxWidth="360px",n.style.padding="0.8em",a.show(t,s),n.onclick=e=>e.stopPropagation(),n.querySelector("#error-close").onclick=e=>{e.stopPropagation(),a.hide(t)}}}!function(){if(e.trim())try{const n=g(e);if(0===n.length)return void(t.innerHTML='<div class="message-card"><div class="message-wrapper system"><div class="system-message">数据格式无法解析</div></div></div>');let f="";n.forEach(e=>{s[e.title]=null;const t={};e.log.forEach((s,n)=>{if("s"===s.senderType){const o=s.content,c=(o.includes("通过")||o.includes("接受")||o.includes("同意"))&&o.includes("通话")&&(o.includes("申请")||o.includes("请求")),a=o.includes("拒绝")&&o.includes("通话")&&(o.includes("申请")||o.includes("请求"));if(c||a)for(let s=n-1;s>=0;s--){const n=e.log[s];if("s"===n.senderType){const e=n.content;if(e.includes("申请")&&(e.includes("视频")||e.includes("语音"))){t[s]=c?"accepted":"rejected";break}}}}});let n="";e.log.forEach((s,o)=>{if("s"===s.senderType){const c=s.content,a=c.includes("申请")&&(c.includes("视频")||c.includes("语音"));let i=null;if(a){const e=c.match(/^([^申请]+?)申请/);e&&(i=e[1].trim())}let l=!1,r=!1;a&&i&&e.receive&&e.send&&("{{user}}"===e.receive?i===e.send||i.includes(e.send)?r=!0:("{{user}}"===i||i.includes("{{user}}"))&&(l=!0):i===e.send||i.includes(e.send)?l=!0:(i===e.receive||i.includes(e.receive))&&(r=!0));const d=(c.includes("通过")||c.includes("接受")||c.includes("同意"))&&c.includes("通话")&&(c.includes("申请")||c.includes("请求")),u=c.includes("拒绝")&&c.includes("通话")&&(c.includes("申请")||c.includes("请求")),m=t[o];if(l)if("accepted"===m){const e=c.includes("视频");n+=`<div class="message-wrapper center" data-msg-index="${o}"><div class="message-bubble call-accepted-bubble" data-call-type="${e?"video":"voice"}"><i class="fa-solid ${e?"fa-video":"fa-phone"}"></i><span>${e?"视频通话中":"语音通话中"}</span></div></div>`}else if("rejected"===m){const e=c.includes("视频");n+=`<div class="message-wrapper center" data-msg-index="${o}"><div class="message-bubble call-rejected-bubble"><i class="fa-solid ${e?"fa-video":"fa-phone"}"></i><span>${e?"视频通话已拒绝":"语音通话已拒绝"}</span></div></div>`}else{const e=c.includes("视频");n+=`<div class="message-wrapper center" data-msg-index="${o}"><div class="message-bubble call-waiting-bubble" data-call-type="${e?"video":"voice"}"><i class="fa-solid ${e?"fa-video":"fa-phone"}"></i><span>等待接通中……</span></div></div>`}else if(r)if("accepted"===m){const e=c.includes("视频");n+=`<div class="message-wrapper center" data-msg-index="${o}"><div class="message-bubble call-accepted-bubble" data-call-type="${e?"video":"voice"}"><i class="fa-solid ${e?"fa-video":"fa-phone"}"></i><span>${e?"视频通话中":"语音通话中"}</span></div></div>`}else if("rejected"===m){const e=c.includes("视频");n+=`<div class="message-wrapper center" data-msg-index="${o}"><div class="message-bubble call-rejected-bubble"><i class="fa-solid ${e?"fa-video":"fa-phone"}"></i><span>${e?"视频通话已拒绝":"语音通话已拒绝"}</span></div></div>`}else{let e="对方";const t=c.match(/^([^申请{]+?)(?:申请|想要|希望)/);t&&(e=t[1].trim());const s=c.includes("视频"),a=s?"video":"voice",i=s?"视频通话":"语音电话",l=s?"fa-video":"fa-phone";n+=`<div class="message-wrapper center" data-msg-index="${o}"><div class="message-bubble call-request-bubble" data-sender-name="${escape(e)}" data-call-type="${a}"><i class="fa-solid ${l}"></i><span>${e} 申请${i}</span></div></div>`}else if(d||u);else{c.includes("挂断")&&(c.includes("视频")||c.includes("语音")||c.includes("电话"))||(n+=`<div class="message-wrapper system" data-msg-index="${o}"><div class="system-message">${c}</div></div>`)}}else{const t="群聊"===e.type?`<div class="message-username">${s.senderName}</div>`:"";let c;const a=t=>{if("{{user}}"===t||"我"===t)return!0;if("私聊"===e.type&&e.receive&&"{{user}}"!==e.receive&&t===e.receive)return!0;if("群聊"===e.type){const s=[e.send,...e.receive?e.receive.split(",").map(e=>e.trim()):[]];if(!s.some(e=>"{{user}}"===e||e.includes("{{user}}"))){const n=s.filter(t=>t!==e.send);if(1===n.length&&n[0]===t)return!0}}return!1};if("群聊"===e.type&&e.send&&e.receive){c=[e.send,...e.receive?e.receive.split(",").map(e=>e.trim()):[]].some(e=>"{{user}}"===e||e.includes("{{user}}"))?a(s.senderName)?"user":"friend":s.senderName===e.send?"user":"friend"}else c=e.receive&&"私聊"===e.type?(e.receive,a(s.senderName)?"user":"friend"):a(s.senderName)||"send"===s.senderType?"user":"friend";let i="",l="";switch(s.contentType){case"voice":i=`<div class="message-bubble voice-bubble"><i class="fa-solid fa-waveform"></i> ${Math.max(1,Math.round(s.content.length/4))}s</div>`,l=`<div class="message-extra-info">转文本: ${s.content}</div>`;break;case"media":if(s.content.includes("<img>")&&s.content.includes("</img>")){const e=s.content.match(/<img>(.*?)<\/img>/);if(e){const t=e[1];i=`<div class="message-bubble image-preview-bubble" style="background-image: url('${t}'); background-size: cover; background-position: center;" data-full-text="${escape(s.content)}" onclick="showImagePreview('${t}', '图片')"></div>`}else{const e=s.content.length>30?s.content.substring(0,30)+"...":s.content;i=`<div class="message-bubble image-preview-bubble" data-full-text="${escape(s.content)}">${e}</div>`}}else{const e=s.content.length>30?s.content.substring(0,30)+"...":s.content;i=`<div class="message-bubble image-preview-bubble" data-full-text="${escape(s.content)}">${e}</div>`}break;case"quote":{const e=s.content.split(">").map(e=>e.trim()),t=e[0]||"";i=`<div class="message-bubble">${e[1]||""}</div>`,l=`<div class="message-extra-info">${t.includes(":")?t.split(":").slice(1).join(":").trim():t}</div>`;break}case"redenvelope":let t=!1;const n=[`{{user}}领取了${s.senderName}的红包`,`{{user}}领取了 ${s.senderName} 的红包`,`{{user}}领取了${s.senderName}的红包。`,`{{user}}领取了 ${s.senderName} 的红包。`];for(let s=o+1;s<e.log.length;s++){const o=e.log[s];if("s"===o.senderType&&n.some(e=>o.content.includes(e))){t=!0;break}}const[c,a]=s.content.split(">").map(e=>e.trim());i=`<div class="message-bubble red-packet-bubble${t?" claimed":""}" data-sender-name="${escape(s.senderName)}" data-is-claimed="${t}"><div class="red-packet-text"><div class="amount">¥${c}</div><div class="memo">${a||"恭喜发财"}</div></div></div>`;break;case"location":i=`<div class="message-bubble location-bubble"><div class="location-text">${s.content}</div><div class="location-map"></div></div>`;break;case"videocall":case"voicecall":i="";break;case"sticker":i=`<div class="sticker-placeholder" data-sticker-description="${escape(s.content)}"><i class="fa-regular fa-face-laugh" style="font-size: 2em; margin: 0.2em;"></i><div style="font-size: 0.8em; color: var(--text-secondary);">${s.content}</div></div>`;break;default:i=`<div class="message-bubble">${s.content}</div>`}i&&(n+=`<div class="message-wrapper ${c}"><div class="message-bubble-container">${t}${i}${l}</div></div>`)}});let o="",c="";"群聊"===e.type?(o=`<div class="chat-session group-header"><h3 class="session-title">${e.title}</h3><button class="toggle-members-btn" title="查看成员"><i class="fa-solid fa-user"></i></button></div>`,e.members.length>0&&(c=`<div class="session-members">成员: ${e.members.join(", ")}</div>`)):o=`<div class="chat-session"><h3 class="session-title">${e.title}</h3></div>`;const a="私聊"===e.type?"private-chat":"";f+=`<div class="message-card" data-chat-type="${e.type}" data-chat-title="${escape(e.title)}">${o}${c}<div class="chat-content ${a}" data-title="${e.title}">${n}</div><div class="action-icon-bar"><i class="fa-regular fa-smile action-icon" data-action="sticker" title="表情包"></i><i class="fa-regular fa-image action-icon mode-toggle-icon" data-action="media" title="图片描述"></i><i class="fa-solid fa-location-dot action-icon mode-toggle-icon" data-action="location" title="定位"></i><i class="fa-solid fa-microphone action-icon mode-toggle-icon" data-action="voice" title="语音"></i><i class="fa-solid fa-gift action-icon" data-action="redenvelope" title="红包"></i><i class="fa-solid fa-video action-icon" data-action="videocall" title="视频通话"></i><i class="fa-solid fa-phone action-icon" data-action="voicecall" title="语音电话"></i><i class="fa-solid fa-gear action-icon mode-toggle-icon" data-action="system" title="系统消息"></i></div><div class="chat-input-area"><input type="text" class="chat-input" data-title="${e.title}" placeholder="回复..."><button class="send-button" data-title="${e.title}">发送</button></div><div class="popup-overlay"><div class="popup-content"></div></div></div>`}),t.innerHTML=f,document.querySelectorAll(".chat-content").forEach(e=>e.scrollTop=e.scrollHeight),n.forEach(e=>{const s=t.querySelector(`.chat-content[data-title="${e.title}"]`);if(!s)return;if(s.querySelectorAll(".call-waiting-bubble, .call-request-bubble, .call-accepted-bubble, .call-rejected-bubble, .call-ended-bubble").length>0)return void console.log(`[通话气泡] ${e.title} 已有通话气泡，跳过重复创建`);let n=!1,o=!1,c=!1;if(e.log.forEach(e=>{"voicecall"===e.contentType&&(n=!0),"videocall"===e.contentType&&(o=!0),"s"===e.senderType&&e.content.includes("挂断")&&(e.content.includes("视频")||e.content.includes("语音")||e.content.includes("电话"))&&(c=!0)}),n||o){const e=o?"video":"voice",t=w.getIcon(e),n=w.getText(e),a=T(c?"call-ended-bubble":"call-accepted-bubble",`<i class="fa-solid ${t}"></i><span>${n}${c?"通话已结束":"通话中"}</span>`,{callType:e});a.querySelector(".message-bubble").onclick=()=>{const t=s.closest(".message-card");c?$(t,e):k(t,e)},s.appendChild(a),s.scrollTop=s.scrollHeight}}),async function(){const e=document.querySelectorAll(".sticker-placeholder");if(0===e.length)return;const t=new Map;e.forEach(e=>{const s=unescape(e.dataset.stickerDescription);t.has(s)||t.set(s,[]),t.get(s).push(e)});for(const[e,s]of t){const t=await p(e);t&&s.forEach(s=>{s.outerHTML=`<img class="sticker-image" src="${t}" alt="${e}" style="max-width: 150px; max-height: 150px; display: block;" onerror="this.outerHTML='<div class=\\'sticker-placeholder\\'><i class=\\'fa-regular fa-face-laugh\\' style=\\'font-size: 2em; margin: 0.2em;\\'></i><div style=\\'font-size: 0.8em; color: var(--text-secondary);\\'>${e}</div></div>';" />`})}}(),function(){const n=e=>{e.dataset.longPressed="true",e.dataset.longPressedMenu="true",l(e),setTimeout(()=>delete e.dataset.longPressed,300),setTimeout(()=>delete e.dataset.longPressedMenu,500)};function p(){t.querySelectorAll(".message-card").forEach(e=>{if(!e.querySelector(".sticker-suggestions")){const t=document.createElement("div");t.className="sticker-suggestions",e.appendChild(t)}})}let g;q(t,".message-bubble, .system-message, .sticker-image, .sticker-placeholder",e=>{o||n(e)}),document.addEventListener("click",function(e){document.querySelector('[data-long-pressed-menu="true"]')?console.log("[点击事件] 检测到长按菜单保护期，跳过隐藏操作菜单"):e.target.closest(".bubble-actions")||e.target.closest(".message-bubble")||e.target.closest(".system-message")||r()}),t.addEventListener("click",async function(t){const n=t.target,c=n.closest(".message-card");if(!c)return;c.dataset.chatType;const l=unescape(c.dataset.chatTitle);if(o){const e=n.closest(".checkbox-circle");if(e){const s=e.closest(".message-wrapper");if(s)return t.stopPropagation(),void u(s,e)}const s=n.closest(".message-wrapper");if(s&&!n.closest(".checkbox-circle")&&!n.closest(".action-icon")&&!n.closest(".popup-overlay")){const e=s.querySelector(".checkbox-circle");if(e)return t.stopPropagation(),void u(s,e)}}const r=n.closest(".action-icon");if(r&&!r.classList.contains("disabled")){const e=r.dataset.action;if("redenvelope"===e)!function(e){const t=e.querySelector(".popup-overlay"),s=e.dataset.chatType,n=unescape(e.dataset.chatTitle),o=t.querySelector(".popup-content");o.className="popup-content red-packet-popup",a.resetOverlayStyle(t),a.show(t,'<h4 style="text-align: center; font-weight: bold; margin-bottom: 1em;">发红包</h4>\n           <input type="text" class="chat-input popup-input" id="popup-input-main" placeholder="金额" autocomplete="off" spellcheck="false">\n           <input type="text" class="chat-input popup-input" id="popup-input-extra" placeholder="备注 (可选)" autocomplete="off" spellcheck="false">\n           <div class="popup-buttons">\n             <button class="send-button" id="popup-submit">确认</button>\n             <button class="send-button" id="popup-cancel" style="background: #666;">取消</button>\n           </div>'),o.onclick=e=>{e.stopPropagation()},o.querySelector("#popup-submit").onclick=async e=>{e.stopPropagation();const c=o.querySelector("#popup-input-main").value.trim(),i=o.querySelector("#popup-input-extra")?.value.trim();if(!c)return;a.hide(t);const[l,r]=[c,i||"恭喜发财"],d=document.querySelector(`.chat-content[data-title="${n}"]`);if(d){const e=document.createDocumentFragment(),t=document.createElement("div");t.className="message-wrapper user";const o=d.classList.contains("private-chat")?"":'<div class="message-username">{{user}}</div>',c=`<div class="message-bubble red-packet-bubble" data-sender-name="${escape("{{user}}")}" data-is-claimed="false"><div class="red-packet-text"><div class="amount">¥${l}</div><div class="memo">${r}</div></div></div>`;t.innerHTML=`<div class="message-bubble-container">${o}${c}</div>`,e.appendChild(t),d.appendChild(e),d.scrollTop=d.scrollHeight,setTimeout(async()=>{try{console.log("[红包发送] 开始写入红包消息到楼层");const e=getCurrentMessageId(),t=getChatMessages(e)[0]?.message||"";if(t){const o=`${y(n,s,t)} | redenvelope: ${l}>${r}`;console.log("[红包发送] 准备写入的消息:",o);const c=b(t,n,s,o);c!==t?(await setChatMessages([{message_id:e,message:c}],{refresh:"none"}),console.log("[红包发送] 红包消息已写入楼层")):console.log("[红包发送] 楼层内容未发生变化，写入可能失败")}}catch(e){console.error("[红包发送] 写入楼层时出错:",e)}},0)}},o.querySelector("#popup-cancel").onclick=e=>{e.stopPropagation(),a.hide(t)}}(c);else if("videocall"===e){const e=c.querySelector(".chat-content"),t=e?.querySelector('.call-accepted-bubble[data-call-type="video"]');t?k(c,"video"):x(c,"video")}else if("voicecall"===e){const e=c.querySelector(".chat-content"),t=e?.querySelector('.call-accepted-bubble[data-call-type="voice"]');t?k(c,"voice"):x(c,"voice")}else if("sticker"===e)L(c);else if("i"===e)!function(e){const t=e.closest(".message-card"),n=unescape(t.dataset.chatTitle);"media"===s[n]?(s[n]=null,e.classList.remove("active"),i(n,"text")):(s[n]="media",t.querySelectorAll(".action-icon.mode-toggle-icon").forEach(e=>{e.classList.remove("active")}),e.classList.add("active"),i(n,"media"))}(r);else if(r.classList.contains("mode-toggle-icon")){const t=s[l];c.querySelectorAll(".action-icon.active").forEach(e=>e.classList.remove("active")),t===e?(s[l]=null,i(l,"text")):(s[l]=e,r.classList.add("active"),i(l,e))}return}c.querySelector(".popup-overlay");const d=n.closest(".call-request-bubble");if(d){const t=unescape(d.dataset.senderName),s=d.dataset.callType;return void function(t,s,n){const o=t.querySelector(".popup-overlay"),c=t.dataset.chatType,i=unescape(t.dataset.chatTitle),l="video"===n?"视频通话":"语音电话",r=`\n            <h4 style="text-align: center; font-weight: bold; margin-bottom: 1em;">${l}申请</h4>\n            <p style="text-align: center; margin-bottom: 1.5em; color: var(--text-secondary);">${s} 申请与您进行${l}</p>\n            <div class="popup-buttons">\n                <button class="send-button" id="call-accept" style="background: #4CAF50;">接听</button>\n                <button class="send-button" id="call-reject" style="background: #f44336;">拒绝</button>\n            </div>`,d=o.querySelector(".popup-content");d.className="popup-content red-packet-popup",a.resetOverlayStyle(o),a.show(o,r),d.onclick=e=>e.stopPropagation(),d.querySelector("#call-accept").onclick=async t=>{t.stopPropagation(),a.hide(o);try{const t=getCurrentMessageId(),s=getChatMessages(t)[0]?.message||"";if(s){const o=b(s,i,c,"system: {{user}}通过了你的通话申请");o!==s&&(await setChatMessages([{message_id:t,message:o}],{refresh:"none"}),e=o,S(i,n,"accepted"))}}catch(e){console.error("[通话-接听] 写入楼层时出错:",e)}},d.querySelector("#call-reject").onclick=async t=>{t.stopPropagation(),a.hide(o);try{const t=getCurrentMessageId(),s=getChatMessages(t)[0]?.message||"";if(s){const o=b(s,i,c,"system: {{user}}拒绝了你的通话申请");o!==s&&(await setChatMessages([{message_id:t,message:o}],{refresh:"none"}),e=o,S(i,n,"rejected"))}}catch(e){console.error("[通话-拒绝] 写入楼层时出错:",e)}}}(c,t,s)}const m=n.closest(".call-accepted-bubble");if(m){const e=m.dataset.callType;return void k(c,e)}const p=n.closest(".call-ended-bubble");if(p){const e=p.dataset.callType;return void $(c,e)}const g=n.closest(".image-preview-bubble, .red-packet-bubble");if(g)return"true"===g.dataset.longPressed?void console.log("[气泡点击] 检测到长按标记，跳过弹窗显示"):void setTimeout(()=>{"true"!==g.dataset.longPressed?f(g,c):console.log("[气泡点击] 延迟检测到长按标记，取消弹窗")},10);function f(e,t){const s=t.querySelector(".popup-overlay"),n=t.querySelector(".popup-content"),o=unescape(t.dataset.chatTitle);if(e.classList.contains("image-preview-bubble")){const t=unescape(e.dataset.fullText);let o="";if(t.includes("<img>")&&t.includes("</img>")){const e=t.match(/<img>(.*?)<\/img>/);if(e){o=`<img src="${e[1]}" style="max-width: 100%; max-height: 100%; object-fit: contain;" />`}else o=`<p style="margin: 0;">${t}</p>`}else o=`<p style="margin: 0;">${t}</p>`;n.innerHTML=o,n.className="popup-content image-popup",n.style.cssText="",a.resetOverlayStyle(s),a.show(s)}else if(e.classList.contains("red-packet-bubble")){const t=unescape(e.dataset.senderName),c="true"===e.dataset.isClaimed,i=c?"red-packet-open-btn claimed":"red-packet-open-btn",l=c?"disabled":"";n.innerHTML=`<p>来自 ${t} 的红包</p><button class="${i}" data-sender-name="${escape(t)}" ${l?"disabled":""}>开</button>`,n.className="popup-content red-packet-claim-popup";const r=n.querySelector(".red-packet-open-btn");r&&!r.disabled&&r.addEventListener("click",async function(t){t.stopPropagation();const n=unescape(this.dataset.senderName),c="我"===n?"{{user}}领取了{{user}}的红包":`{{user}}领取了${n}的红包`;e.dataset.isClaimed="true",e.classList.add("claimed"),a.hide(s);const i=document.querySelector(`.chat-content[data-title="${o}"]`);if(i){const e=document.createDocumentFragment(),t=document.createElement("div");t.className="message-wrapper system";const s=document.createElement("div");s.className="system-message",s.textContent=c,t.appendChild(s),e.appendChild(t),i.appendChild(e),i.scrollTop=i.scrollHeight,setTimeout(async()=>{try{console.log("[红包领取] 开始写入系统消息到楼层:",c);const e=getCurrentMessageId(),t=getChatMessages(e)[0]?.message||"",s=i.closest(".message-card").dataset.chatType;if(t){const n=b(t,o,s,`system: ${c}`);n!==t&&(await setChatMessages([{message_id:e,message:n}],{refresh:"none"}),console.log("[红包领取] 系统消息已写入楼层"))}}catch(e){console.error("[红包领取] 写入楼层时出错:",e)}},0)}}),a.show(s)}}const v=n.closest(".popup-overlay");if(v){return void(n.closest(".popup-content")||(v.style.display="none"))}const h=n.closest(".send-button");if(h){const e=h.closest(".message-card"),t=(e.dataset.chatType,unescape(e.dataset.chatTitle));return void await async function(e,t,n){console.log("[发送按钮] 处理发送消息，标题:",e),n.classList.add("sending"),n.disabled=!0;try{s[e]=null,i(e,"text");const t=n.closest(".message-card");t&&t.querySelectorAll(".action-icon.active").forEach(e=>e.classList.remove("active")),console.log("[发送按钮] 触发send_but");const o=parent.document.querySelector("#send_but");if(o){const e=parent.document.querySelector("#send_textarea");e&&(e.value=""),o.click()}}catch(e){console.error("[发送按钮] 处理失败:",e)}finally{setTimeout(()=>{n.classList.remove("sending"),n.disabled=!1},500)}}(t,0,h)}if(n.closest(".toggle-members-btn")){const e=c.querySelector(".session-members");e&&e.classList.toggle("visible")}}),t.addEventListener("keypress",async function(e){if("Enter"!==e.key)return;const t=e.target.closest(".chat-input");if(t){e.preventDefault();const n=t.closest(".message-card"),o=unescape(n.dataset.chatTitle),c=n.dataset.chatType,a=t.value.trim();if(a){const e=s[o]||"text";let l="";if("system"===e)m(o,a,"system"),l=`system: ${a}`,s[o]=null,i(o,"text"),n.querySelectorAll(".action-icon.active").forEach(e=>{e.classList.remove("active")});else if("quote"===e&&t.dataset.quotedText){const r=t.dataset.quotedText;m(o,`${t.dataset.quotedSender||"用户"}: ${r}>${a}`,e);try{const e=getCurrentMessageId(),t=getChatMessages(e)[0]?.message||"";l=`${y(o,c,t)} | quote: ${r}>${a}`}catch(e){l=`{{user}} | quote: ${r}>${a}`}delete t.dataset.quotedText,delete t.dataset.quotedSender,s[o]=null,i(o,"text"),n.querySelectorAll(".action-icon.active").forEach(e=>{e.classList.remove("active")})}else{m(o,a,e);try{const t=getCurrentMessageId(),s=getChatMessages(t)[0]?.message||"";l=`${y(o,c,s)} | ${e}: ${a}`}catch(t){l=`{{user}} | ${e}: ${a}`}}t.value="";const r=n.querySelector(".sticker-suggestions");r&&(r.classList.remove("show"),r.innerHTML=""),console.log("[回车触发] 立即写入楼层，chatTitle:",o);try{const e=getCurrentMessageId(),t=getChatMessages(e)[0]?.message||"";if(t&&l){console.log("[回车触发] 准备写入的消息:",l);const a=b(t,o,c,l);a!==t?(await setChatMessages([{message_id:e,message:a}],{refresh:"none"}),console.log("[回车触发] 消息已写入楼层"),s[o]=null,i(o,"text"),n.querySelectorAll(".action-icon.active").forEach(e=>e.classList.remove("active"))):console.log("[回车触发] 楼层内容未发生变化，写入可能失败")}}catch(e){console.error("[回车触发] 写入楼层时出错:",e)}}}}),t.ownerDocument.addEventListener("click",function(s){s.target.closest('[data-role="inline-delete"]')&&async function(){if(0===c.size)return;const e=[],s=Array.from(c).sort((e,t)=>{const[,s]=e.split("-"),[,n]=t.split("-");return parseInt(n)-parseInt(s)});for(const n of s){const[s,o]=n.split("-"),c=t.querySelector(`.chat-content[data-title="${s}"]`);if(!c)continue;const a=c.querySelectorAll(".message-wrapper"),i=parseInt(o);if(i>=0&&i<a.length){const t=a[i];if(t){const n=t.querySelector(".message-bubble"),o=t.querySelector(".system-message"),c=t.querySelector(".sticker-image"),a=t.querySelector(".sticker-placeholder");let i="";if(n)if(n.classList.contains("red-packet-bubble")){const e=n.querySelector(".amount"),t=n.querySelector(".memo");i=`${e?e.textContent.replace("¥","").trim():""}>${t?t.textContent.trim():""}`}else if(n.classList.contains("image-preview-bubble")){const e=n.dataset.fullText;i=e?unescape(e):n.textContent||n.innerText||""}else if(n.classList.contains("location-bubble")){const e=n.querySelector(".location-text");i=e?e.textContent.trim():""}else if(n.classList.contains("video-bubble")){const e=n.querySelector(".card-title");i=e?e.textContent.trim():""}else i=n.textContent||n.innerText||"";else if(c)i=c.alt||"";else if(a){const e=a.querySelector('div[style*="font-size: 0.8em"]');i=e?e.textContent.trim():a.textContent.trim()}else o&&(i=o.textContent||o.innerText||"");i&&e.push({chatTitle:s,messageText:i}),t.remove()}}}d(),e.length>0&&setTimeout(async()=>{try{const t=getCurrentMessageId(),s=getChatMessages(t)[0]?.message||"";if(s){let n=s,o=0;for(const{chatTitle:t,messageText:s}of e){const e=document.querySelector(`.message-card[data-chat-title="${escape(t)}"]`),c=e?.dataset.chatType;if(c){const e=n;n=h(n,t,c,s),n!==e&&o++}}n!==s&&await setChatMessages([{message_id:t,message:n}],{refresh:"none"})}}catch(e){console.error("[删除消息] 从楼层删除时出错:",e)}},0)}();s.target.closest('[data-role="inline-cancel"]')&&d();const n=s.target.closest(".sticker-suggestion-item");if(n){const t=n.closest(".message-card"),s=unescape(n.dataset.description),o=n.dataset.imageUrl,c=unescape(t.dataset.chatTitle),a=t.dataset.chatType,i=t.querySelector(".sticker-suggestions");i&&(i.classList.remove("show"),i.innerHTML="");const l=t.querySelectorAll('input[type="text"]');for(const e of l)if(!e.closest(".popup-overlay")){e.value="";break}const r=t.querySelector(".chat-content");if(r){const t=document.createDocumentFragment(),n=document.createElement("div");n.className="message-wrapper user";const i=document.createElement("div");i.className="message-bubble-container";const l=document.createElement("img");l.className="sticker-image",l.src=o,l.alt=s,l.style.maxWidth="120px",l.style.maxHeight="120px",l.style.display="block",l.style.objectFit="contain",i.appendChild(l),n.appendChild(i),t.appendChild(n),r.appendChild(t),r.scrollTop=r.scrollHeight,setTimeout(async()=>{try{const t=getCurrentMessageId(),n=getChatMessages(t)[0]?.message||"";if(n){const o=y(c,a,n),i=b(n,c,a,`${o} | sticker: ${s}`);i!==n&&(await setChatMessages([{message_id:t,message:i}],{refresh:"none"}),console.log("[表情包] 表情包已写入楼层"),e=i)}}catch(e){console.error("[表情包] 写入楼层时出错:",e)}},0)}}const o=s.target.closest(".sticker-suggestions"),a=s.target.closest('input[type="text"]');o||a||document.querySelectorAll(".sticker-suggestions.show").forEach(e=>{e.classList.remove("show"),e.innerHTML=""})}),t.ownerDocument.addEventListener("input",async function(e){const t=e.target;if(console.log("[表情包推荐] input事件触发, 目标:",t.tagName,t.type,t.className),"INPUT"===t.tagName&&"text"===t.type){const e=t.selectionStart;if(null!==e){const s=t.value.substring(0,e),n=document.createElement("canvas").getContext("2d"),o=window.getComputedStyle(t);n.font=`${o.fontSize} ${o.fontFamily}`;const c=n.measureText(s).width,a=t.offsetWidth;t.scrollLeft=c>a-20?c-a+40:0}}if("INPUT"===t.tagName&&"text"===t.type&&!t.closest(".popup-overlay")){console.log("[表情包推荐] 符合条件, 输入值:",t.value),clearTimeout(g);const e=t.closest(".message-card");if(!e)return void console.log("[表情包推荐] 未找到message-card");let s=e.querySelector(".sticker-suggestions");s||(s=document.createElement("div"),s.className="sticker-suggestions",e.appendChild(s));const n=t.value.trim();if(!n)return s.classList.remove("show"),void(s.innerHTML="");g=setTimeout(async()=>{try{console.log("[表情包推荐] 开始搜索:",n);const e=await async function(e){if(!e||0===e.trim().length)return[];const t=[],s=e.trim().toLowerCase();try{let e=[];const n=getGlobalWorldbookNames();for(const t of n)try{const s=await getWorldbook(t);s&&Array.isArray(s)&&(e=e.concat(s))}catch(e){console.error(`[表情包推荐] 获取世界书 "${t}" 失败:`,e)}const o=e.filter(e=>{const t=(e.name||"").toLowerCase(),s=e.strategy?.keys?e.strategy.keys.map(e=>String(e)).join(",").toLowerCase():"",n=e.strategy?.keys_secondary?.keys?e.strategy.keys_secondary.keys.map(e=>String(e)).join(",").toLowerCase():"";return t.includes("sticker")||t.includes("表情包")||s.includes("sticker")||s.includes("表情包")||n.includes("sticker")||n.includes("表情包")});for(const e of o){const n=(e.content||"").split("\n").filter(e=>e.trim());for(const e of n){const n=e.indexOf(":");if(n>0){const o=e.substring(0,n).trim();let c=e.substring(n+1).trim();if(o.toLowerCase().includes(s)&&c){c=c.replace(/\s+/g,"").replace(/['"]/g,"");const e=c.includes("/")?`https://i.postimg.cc/${c}`:`https://files.catbox.moe/${c}`;if(t.push({description:o,imageUrl:e}),t.length>=15)return t}}}}}catch(e){console.error("[表情包推荐] 搜索失败:",e)}return t}(n);if(console.log("[表情包推荐] 搜索结果数量:",e.length),0===e.length)return s.classList.remove("show"),void(s.innerHTML="");let t="";for(const s of e)t+=`\n                      <div class="sticker-suggestion-item" data-description="${escape(s.description)}" data-image-url="${s.imageUrl}">\n                        <img src="${s.imageUrl}" alt="${s.description}" loading="lazy" />\n                      </div>\n                    `;s.innerHTML=t,s.classList.add("show")}catch(e){console.error("[表情包建议] 搜索失败:",e)}},300)}}),console.log("[表情包推荐] 初始化表情包推荐功能"),p()}()}catch(e){console.error("渲染UI时出错:",e)}else t.innerHTML='<div class="message-card"><div class="message-wrapper system"><div class="system-message">没有聊天数据</div></div></div>'}();new MutationObserver(()=>{t.querySelectorAll(".message-card").forEach(e=>{if(!e.querySelector(".sticker-suggestions")){const t=document.createElement("div");t.className="sticker-suggestions",e.appendChild(t)}})}).observe(t,{childList:!0,subtree:!0})}()</script></body></html>